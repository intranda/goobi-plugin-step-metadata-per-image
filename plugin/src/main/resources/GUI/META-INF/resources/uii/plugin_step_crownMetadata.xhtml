<!-- 
 * This file is part of a plugin for Goobi - a Workflow tool for the support of mass digitization.
 * 
 * Visit the websites for more information. 
 *          - https://goobi.io
 *          - https://www.intranda.com
 *          - https://github.com/intranda/goobi
 * 
 * This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 2 of the License, or (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 59
 * Temple Place, Suite 330, Boston, MA 02111-1307 USA
 * 
 -->
<ui:composition
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:o="http://omnifaces.org/ui"
    xmlns:of="http://omnifaces.org/functions"
    template="/uii/templatePG/templatePG.html"
    xmlns:x="http://myfaces.apache.org/tomahawk"
    xmlns:jsf="http://xmlns.jcp.org/jsf"
    xmlns:intranda="http://xmlns.jcp.org/jsf/composite/compositesPG">

    <ui:param
        name="myPageTitle"
        value="#{msgs.plugin}: #{msgs[('plugin_').concat(AktuelleSchritteForm.myPlugin.title)]}" />

    <ui:define name="breadcrumb">
        <intranda:breadcrumb
            label="#{msgs.startseite}"
            action="index"
            navId="a0" />

        <c:if test="#{LoginForm.hasRole('Workflow_Processes') and NavigationForm.uiStatus.pluginSimulation == true}">
            <intranda:breadcrumb
                id="processAll"
                label="#{ProzessverwaltungForm.modusAnzeige=='aktuell'?msgs.aktuelleProzesse:msgs.prozessvorlagen}"
                action="process_all"
                navId="a1" />
            <intranda:breadcrumb
                id="processEdit"
                label="#{ProzessverwaltungForm.modusAnzeige=='aktuell'?msgs.prozessDetails:msgs.process_templateDetails}"
                action="process_edit" />
        </c:if>

        <c:if test="#{NavigationForm.uiStatus.pluginSimulation != true}">
            <intranda:breadcrumb
                label="#{msgs.aktuelleSchritte}"
                action="#{AktuelleSchritteForm.paginator.returnToPreviousPage}" />
            <intranda:breadcrumb
                label="#{AktuelleSchritteForm.mySchritt.prozess.titel}"
                action="#{AktuelleSchritteForm.myPlugin.cancel}" />
        </c:if>

        <intranda:breadcrumb
            label="#{myPageTitle}"
            noSeparator="#{true}" />
    </ui:define>

    <ui:define name="info">
    </ui:define>

    <ui:define name="content">


        <style>
.star {
    display: block;
    float: left;
}

.star i {
    color: #ccc;
}

.star .active {
    color: #368ee0;
}

.form-control.invalid, .form-select.invalid {
    border: 1px solid var(--clr-box-hot);
}

.font-danger.validation-message {
    color: var(--clr-box-hot);
}

.warning-icon {
    padding-left: 3px;
    font-size: 18px;
    margin-right: 5px;
}

.form_field {
    margin-bottom: 4px;
}
</style>


        <h:form
            id="myform"
            prependId="false">
            <h:inputHidden
                id="focusField"
                value="#{AktuelleSchritteForm.myPlugin.focusField}" />
            <intranda:box
                boxType="primary"
                boxTitle="false"
                boxForm="false">

                <intranda:boxTitle
                    title="#{AktuelleSchritteForm.myPlugin.step.titel}"
                    icon="fa-puzzle-piece">

                    <div class="actions d-flex">


                        <h:commandLink
                            tabindex="-1"
                            id="id10"
                            action="#{NavigationForm.Reload}"
                            styleClass="btn d-flex align-items-center btn--title-action">
                            <i class="fa fa-refresh" />
                        </h:commandLink>
                        <h:commandLink
                            tabindex="-1"
                            action="#{AktuelleSchritteForm.myPlugin.saveMetadata}"
                            styleClass="btn d-flex align-items-center btn--title-action"
                            title="#{msgs.speichern}">
                            <i class="fa fa-floppy-o" />
                            <x:updateActionListener
                                property="#{NavigationForm.uiStatus.pluginSimulation}"
                                value="#{false}" />
                        </h:commandLink>
                        <h:commandLink
                            tabindex="-1"
                            id="id11"
                            action="#{AktuelleSchritteForm.SchrittDurchBenutzerAbschliessen}"
                            styleClass="btn d-flex align-items-center btn--title-action"
                            rendered="#{NavigationForm.uiStatus.pluginSimulation != true}"
                            title="#{msgs.task_leavePluginAndFinishTask}">
                            <i class="fa fa-check" />
                            <x:updateActionListener
                                property="#{NavigationForm.uiStatus.pluginSimulation}"
                                value="#{false}" />
                        </h:commandLink>

                        <h:commandLink
                            tabindex="-1"
                            id="id12"
                            action="#{AktuelleSchritteForm.myPlugin.cancel}"
                            styleClass="btn d-flex align-items-center btn--title-action"
                            rendered="#{NavigationForm.uiStatus.pluginSimulation != true}"
                            title="#{msgs.pluginLeave}">
                            <i class="fa fa-close" />
                            <x:updateActionListener
                                property="#{NavigationForm.uiStatus.pluginSimulation}"
                                value="#{false}" />
                        </h:commandLink>
                    </div>
                </intranda:boxTitle>


                <div class="p-4">

                    <!-- HEADER ROW -->
                    <div class="row">
                        <div class="col-8">
                            <intranda:formOutputText
                                tabindex="-1"
                                id="title"
                                name="title"
                                label="#{msgs['process_grid_TitleDocMain']}"
                                field="#{AktuelleSchritteForm.myPlugin.publicationElement.title}"
                                help="#{msgs.helpProcessStepTitle}"
                                required="false" />
                            <x:dataList
                                var="metadata"
                                value="#{AktuelleSchritteForm.myPlugin.publicationElement.metadataList}">
                                <intranda:formOutputText
                                    tabindex="-1"
                                    id="metadata"
                                    name="metadata"
                                    label="#{msgs['process_grid_'.concat(metadata.one)]}"
                                    field="#{metadata.two}"
                                    help="#{msgs.helpProcessStepTitle}"
                                    required="false" />
                            </x:dataList>

                            <ui:fragment rendered="#{!AktuelleSchritteForm.myPlugin.publicationElement.processReferences.isEmpty()}">
                                <div class="row">
                                    <div class="col-12 col-md-3 control-label">
                                        <h:outputText value="#{msgs.plugin_intranda_step_metadata_per_image_references}" />
                                    </div>
                                    <div class="col-12 col-md-9">
                                        <ui:repeat
                                            var="reference"
                                            value="#{AktuelleSchritteForm.myPlugin.publicationElement.processReferences}">
                                            <div class="btn btn-blank me-2">
                                                <span> <h:outputText
                                                        value="#{reference.otherProcessName} #{msgs.lw_currentImageNumber} #{reference.otherImageNumber}" />
                                                </span>

                                            </div>
                                            <br />
                                        </ui:repeat>
                                    </div>
                                </div>
                            </ui:fragment>
                        </div>
                        <div class="col-4"></div>
                    </div>
                    <!-- // HEADER ROW -->

                    <hr />

                    <!-- EACH IMAGE -->
                    <ui:repeat
                        var="page"
                        value="#{AktuelleSchritteForm.myPlugin.pages}"
                        varStatus="myStatus">

                        <div class="row">
                            <div class="col-8 inputfields">
                                <!-- METADATA EDITION AREA -->
                                <ui:repeat
                                    var="field"
                                    value="#{page.metadata}"
                                    varStatus="fieldstatus">
                                    <ui:repeat
                                        var="entry"
                                        value="#{field.values}">


                                        <h:panelGroup
                                            rendered="#{field.displayType=='input'}"
                                            id="inputfield">
                                            <intranda:formInputTextAjax
                                                id="input"
                                                name="input"
                                                label="#{msgs[field.label]}"
                                                field="#{entry.value}"
                                                help="#{msgs.helpProcessStepTitle}"
                                                displayAsRequired="#{field.required}"
                                                required="false"
                                                readonly="#{field.readonly}"
                                                fieldStyle="#{entry.valid ? '' : 'invalid'}"
                                                execute="@this :focusField"
                                                render=":#{cc.clientId}field"
                                                displayLabel="false"
                                                onfocus="document.getElementById( 'focusField' ).value = this.id;">
                                                <ui:include src="field_label.xhtml" />
                                            </intranda:formInputTextAjax>
                                            <ui:include src="field_validation.xhtml" />
                                        </h:panelGroup>

                                        <h:panelGroup
                                            rendered="#{field.displayType=='textarea'}"
                                            id="areafield">
                                            <intranda:formInputTextAreaAjax
                                                id="area"
                                                name="area"
                                                label="#{msgs[field.label]}"
                                                field="#{entry.value}"
                                                help="#{msgs.helpProcessStepTitle}"
                                                displayAsRequired="#{field.required}"
                                                required="false"
                                                readonly="#{field.readonly}"
                                                fieldStyle="#{entry.valid ? '' : 'invalid'}"
                                                execute="@this :focusField"
                                                render=":#{cc.clientId}field"
                                                displayLabel="false"
                                                onfocus="document.getElementById( 'focusField' ).value = this.id;">
                                                <ui:include src="field_label.xhtml" />
                                                <ui:include src="field_validation.xhtml" />
                                            </intranda:formInputTextAreaAjax>
                                        </h:panelGroup>

                                        <h:panelGroup
                                            rendered="#{field.displayType=='select'}"
                                            id="selectfield">
                                            <intranda:formInputDropDownAjax
                                                id="select"
                                                ajaxEvent="change"
                                                ajaxRender=":#{cc.clientId}field"
                                                label="#{msgs[field.label]}"
                                                field="#{entry.value}"
                                                help="#{msgs.helpLdapAuthenticationType}"
                                                name="select"
                                                displayAsRequired="#{field.required}"
                                                required="false"
                                                selectItems="#{field.valueList}"
                                                fieldStyle="form-select #{entry.valid ? '' : 'invalid'}"
                                                var="item"
                                                itemLabel="#{item}"
                                                itemValue="#{item}"
                                                displayLabel="false"
                                                onfocus="document.getElementById( 'focusField' ).value = this.id;">
                                                <ui:include src="field_label.xhtml" />
                                                <ui:include src="field_validation.xhtml" />
                                            </intranda:formInputDropDownAjax>
                                        </h:panelGroup>

                                        <ui:fragment rendered="#{field.displayType=='gnd'}">
                                            <intranda:formInputGndAjax
                                                id="gnd"
                                                name="gnd"
                                                label="#{msgs[field.label]}"
                                                field="#{entry}"
                                                help="#{msgs.help}"
                                                displayAsRequired="#{field.required}"
                                                required="false"
                                                displayLabel="false"
                                                render="@form"
                                                onfocus="document.getElementById( 'focusField' ).value = this.id;">
                                                <ui:include src="field_label.xhtml" />
                                                <ui:include src="field_validation.xhtml" />
                                            </intranda:formInputGndAjax>
                                        </ui:fragment>

                                        <ui:fragment rendered="#{field.displayType=='geonames'}">
                                            <intranda:formInputGeonamesAjax
                                                id="geonames"
                                                name="geonames"
                                                label="#{msgs[field.label]}"
                                                field="#{entry}"
                                                help="#{msgs.help}"
                                                displayAsRequired="#{field.required}"
                                                required="false"
                                                submitDataAction="#{entry.importGeonamesData()}"
                                                displayLabel="false"
                                                onfocus="document.getElementById( 'focusField' ).value = this.id;"
                                                render="@form">
                                                <ui:include src="field_label.xhtml" />
                                                <ui:include src="field_validation.xhtml" />
                                            </intranda:formInputGeonamesAjax>
                                        </ui:fragment>

                                        <ui:fragment rendered="#{field.displayType=='viaf'}">
                                            <intranda:formInputViafAjax
                                                id="viaf"
                                                name="viaf"
                                                label="#{msgs[field.label]}"
                                                field="#{entry}"
                                                help="#{msgs.help}"
                                                displayAsRequired="#{field.required}"
                                                required="false"
                                                displayLabel="false"
                                                onfocus="document.getElementById( 'focusField' ).value = this.id;"
                                                render="@form">
                                                <ui:include src="field_label.xhtml" />
                                                <ui:include src="field_validation.xhtml" />
                                            </intranda:formInputViafAjax>
                                        </ui:fragment>
                                    </ui:repeat>
                                    <h:panelGroup
                                        rendered="#{field.displayType=='multiselect'}"
                                        id="multiselectfield">
                                        <intranda:formInputMultiSelect
                                            id="multiselect"
                                            name="multiselect"
                                            label="#{msgs[field.label]}"
                                            field="#{field}"
                                            help="#{msgs.help}"
                                            selectItems="#{field.possibleValues}"
                                            var="var"
                                            itemValue="#{var}"
                                            itemLabel="#{var}"
                                            displayAsRequired="#{field.required}"
                                            required="false"
                                            displayLabel="true"
                                            render=":#{cc.clientId}field"
                                            onfocus="document.getElementById( 'focusField' ).value = this.id;" />
                                    </h:panelGroup>

                                </ui:repeat>
                                <div class="row mt-3">
                                    <div class="col-12 col-md-3 control-label">
                                        <h:outputText value="#{msgs.plugin_intranda_step_metadata_per_image_references}" />
                                    </div>

                                    <div class="col-12 col-md-9">

                                        <ui:repeat
                                            var="reference"
                                            value="#{page.processReferences}">
                                            <button
                                                jsf:id="removeReference"
                                                class="btn btn-blank me-2 mb-2"
                                                jsf:action="#{page.deleteProcessReference}">
                                                <i class="fa fa-minus-circle"></i> <span> <h:outputText value="#{reference.otherProcessName}" />
                                                </span>
                                                <f:setPropertyActionListener
                                                    value="#{reference}"
                                                    target="#{page.selectedReference}" />
                                                <f:ajax
                                                    render="@form"
                                                    execute="@this" />
                                            </button>
                                            <br />
                                        </ui:repeat>
                                        <!--  link processes -->
                                        <button
                                            title="#{msgs.plugin_intranda_step_metadata_per_image_addLinkToProcess}"
                                            class="btn btn-primary mt-3"
                                            data-toggle="tooltip"
                                            jsf:id="processSearchBoxButton"
                                            jsf:onclick="$('#processSearchBox').modal('show');">
                                            <h:outputText value="#{msgs.plugin_intranda_step_metadata_per_image_addLink}" />
                                            <f:ajax
                                                execute="@this"
                                                render="processSearchBoxContent" />

                                            <f:setPropertyActionListener
                                                value="#{page}"
                                                target="#{AktuelleSchritteForm.myPlugin.currentPage}" />
                                        </button>
                                    </div>
                                </div>

                                <!-- // METADATA EDITION AREA -->
                            </div>

                            <div class="col-4">
                                <!-- RIGHT AREA FOR IMAGE -->
                                <div
                                    class="goobi-thumbnail-image float-end"
                                    style="height: 404px; max-width: 400px">

                                    <!-- IMAGE DISPLAY -->
                                    <div
                                        class="thumb"
                                        style="max-height: 404px;">
                                        <button
                                            tabindex="-1"
                                            title="#{page.image.tooltip}"
                                            class="btn btn-empty p-0"
                                            data-toggle="tooltip"
                                            href="#{page.image.bookmarkUrl}"
                                            jsf:id="showBookmark1"
                                            jsf:onclick="$('#imageBox').modal('show');">
                                            <canvas
                                                class="thumb-canvas"
                                                style="max-height: 400px;"
                                                data-image_small="#{page.image.thumbnailUrl}"
                                                data-image_large="#{page.image.largeThumbnailUrl}"
                                                title="#{page.image.tooltip}"
                                                id="thumbnail1-#{page.order}"></canvas>
                                            <f:setPropertyActionListener
                                                value="#{page.image.largeThumbnailUrl}"
                                                target="#{AktuelleSchritteForm.myPlugin.imageUrl}" />
                                            <f:setPropertyActionListener
                                                value="#{page.image.tooltip}"
                                                target="#{AktuelleSchritteForm.myPlugin.imageName}" />
                                            <f:ajax
                                                execute="@this"
                                                render="imageBoxContent" />
                                        </button>
                                    </div>
                                    <!-- // IMAGE DISPLAY -->

                                    <div
                                        jsf:id="rating"
                                        title="#{msgs.plugin_intranda_step_metadata_per_image_rating}">
                                        <!-- RATING -->
                                        <ul class="p-0">
                                            <li class="star">
                                                <button
                                                    tabindex="-1"
                                                    class="btn btn-empty p-0"
                                                    jsf:id="rating1">
                                                    <f:ajax
                                                        execute="@this"
                                                        render="rating" />
                                                    <f:setPropertyActionListener
                                                        value="1"
                                                        target="#{page.rating}" />
                                                    <i
                                                        class="fa fa-star #{page.rating > 0 ? 'active' : ''}"
                                                        aria-hidden="true"></i>
                                                </button>
                                            </li>
                                            <li class="star">
                                                <button
                                                    tabindex="-1"
                                                    class="btn btn-empty p-0"
                                                    jsf:id="rating2">
                                                    <f:ajax
                                                        execute="@this"
                                                        render="rating" />
                                                    <f:setPropertyActionListener
                                                        value="2"
                                                        target="#{page.rating}" />
                                                    <i
                                                        class="fa fa-star #{page.rating > 1 ? 'active' : ''}"
                                                        aria-hidden="true"></i>

                                                </button>
                                            </li>
                                            <li class="star">

                                                <button
                                                    tabindex="-1"
                                                    class="btn btn-empty p-0"
                                                    jsf:id="rating3">
                                                    <f:ajax
                                                        execute="@this"
                                                        render="rating" />
                                                    <f:setPropertyActionListener
                                                        value="3"
                                                        target="#{page.rating}" />
                                                    <i
                                                        class="fa fa-star #{page.rating > 2 ? 'active' : ''}"
                                                        aria-hidden="true"></i>
                                                </button>
                                            </li>
                                            <li class="star">
                                                <button
                                                    tabindex="-1"
                                                    class="btn btn-empty p-0"
                                                    jsf:id="rating4">
                                                    <f:ajax
                                                        execute="@this"
                                                        render="rating" />
                                                    <f:setPropertyActionListener
                                                        value="4"
                                                        target="#{page.rating}" />
                                                    <i
                                                        class="fa fa-star #{page.rating > 3 ? 'active' : ''}"
                                                        aria-hidden="true"></i>
                                                </button>
                                            </li>
                                            <li class="star">
                                                <button
                                                    tabindex="-1"
                                                    class="btn btn-empty p-0"
                                                    jsf:id="rating5">
                                                    <f:ajax
                                                        execute="@this"
                                                        render="rating" />
                                                    <f:setPropertyActionListener
                                                        value="5"
                                                        target="#{page.rating}" />
                                                    <i
                                                        class="fa fa-star #{page.rating == 5 ? 'active' : ''}"
                                                        aria-hidden="true"></i>
                                                </button>
                                            </li>
                                        </ul>
                                        <!-- // RATING -->
                                    </div>
                                    <!-- FILE NAME -->
                                    <h:outputText
                                        class="float-end"
                                        value="#{page.image.imageName}" />
                                    <!-- // FILE NAME -->
                                </div>

                                <!-- // RIGHT AREA FOR IMAGE -->

                            </div>
                        </div>

                        <hr jsf:rendered="#{not myStatus.last}" />
                    </ui:repeat>
                    <!-- // EACH IMAGE -->

                </div>


                <div class="form-actions">
                    <!-- leave -->
                    <button
                        class="btn btn-blank"
                        jsf:id="absenden"
                        jsf:action="#{AktuelleSchritteForm.myPlugin.cancel}">
                        <i class="fa fa-close"></i> <span> <h:outputText value="#{msgs.pluginLeave}" />
                        </span>
                        <x:updateActionListener
                            property="#{NavigationForm.uiStatus.pluginSimulation}"
                            value="#{false}" />
                    </button>

                    <!-- Save and finish the task -->
                    <button
                        class="btn btn-success me-3"
                        jsf:id="saveMetadata"
                        jsf:action="#{AktuelleSchritteForm.myPlugin.saveMetadata}">
                        <i class="fa fa-floppy-o"></i> <span> <h:outputText value="#{msgs.speichern}" />
                        </span>
                        <x:updateActionListener
                            property="#{NavigationForm.uiStatus.pluginSimulation}"
                            value="#{false}" />
                    </button>

                </div>

            </intranda:box>

        </h:form>





        <ui:include src="process_search_modal.xhtml" />
        <ui:include src="image_modal.xhtml" />
        <ui:include src="metadata_add_modal.xhtml" />





        <script type="text/javascript">
									$(document).ready(function() {
										saveScrollPosition();
										loadScrollPositionAndJump();
									});

									function saveScrollPosition() {
										$(
												'.inputfields button:not(.modal-dialog button)')
												.on(
														'click',
														function() {
															var scrolled_val = $(
																	document)
																	.scrollTop()
																	.valueOf();
															sessionStorage
																	.setItem(
																			"jumpToScrollPosition",
																			scrolled_val);
															// console.log('page is at ' + scrolled_val + 'px set in session storage');
														});
									}
									function loadScrollPositionAndJump() {

										if (sessionStorage
												.getItem("jumpToScrollPosition") !== null) {
											// console.log('scroll pos from last page exists');

											var scrollPositionFromLastPage = sessionStorage
													.getItem("jumpToScrollPosition");

											window
													.scrollTo({
														top : scrollPositionFromLastPage,
														behavior : 'instant',
													})
											sessionStorage
													.removeItem("jumpToScrollPosition");
											//$("body, html").animate({scrollTop: scrollPositionFromLastPage}, 250).offset().top;
											// console.log('jump now to ' + scrollPositionFromLastPage + 'px and remove session storage item');

										}
									}

									function updateFocus() {
										var focus = $('#focusField').val();
										if (focus != null) {
											const inp = document
													.getElementById(focus);
											if (inp != null) {
												inp.focus();
											}
										}
									}

									window.onload = function() {
										loadImages();
									}

									jsf.ajax.addOnEvent(function(data) {
										var ajaxstatus = data.status; // Can be "begin", "complete" and "success"

										switch (ajaxstatus) {
										case "begin": // This is called right before ajax request is been sent.
											break;

										case "complete": // This is called right after ajax response is received.

											break;

										case "success": // This is called when ajax response is successfully processed.
											var source = data.source;
											loadImages();
											// dont update focus, if source was a button 
											if ("BUTTON" != source.nodeName) {
												updateFocus();
											}
											break;
										}
									});
								</script>


    </ui:define>

</ui:composition>